name: Build & Test

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-dist:
    runs-on: [ubuntu-latest]
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref_name }}
          token: ${{ secrets.GITHUB_TOKEN}}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20 # use stable LTS; previous 24 caused manifest warning
          check-latest: true

      - name: Install dependencies
        working-directory: .github/actions/core
        run: npm ci

      - name: Run tests
        working-directory: .github/actions/core
        run: npm run test

      - name: Build action
        working-directory: .github/actions/core
        run: npm run build

      - name: Commit build artifacts (same-repo PRs only)
        if: github.event.pull_request.head.repo.full_name == github.repository
        uses: EndBug/add-and-commit@v9
        with:
          add: "."
          message: "chore: build core action dist (auto)"
          default_author: github_actions
          push: true

      - name: Fail if dist is dirty (Forked PRs only)
        if: github.event.pull_request.head.repo.full_name != github.repository
        working-directory: .github/actions/core
        run: |
          if [[ -n $(git status --porcelain dist) ]]; then
            echo "::error::The 'dist' folder is out of sync with the source code."
            echo "::error::Because this is a forked PR, we cannot automatically commit the changes."
            echo "::error::Please run 'npm run build' in '.github/actions/core' locally and commit the changes."
            exit 1
          fi

  test-python:
    needs: build-dist
    runs-on: [ubuntu-latest]
    permissions:
      contents: write
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
      - name: Test Python Action (Dry Run)
        id: version_bump
        uses: ./.github/actions/version-bumping/python
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pyproject-file: "test-resources/pyproject.toml"
          dry-run: "true"

      - name: Verify Outputs
        run: |
          echo "Bumped: ${{ steps.version_bump.outputs.bumped }}"
          echo "New Version: ${{ steps.version_bump.outputs.new-version }}"
          echo "### Python Test New Version: ${{ steps.version_bump.outputs.new-version }}" >> $GITHUB_STEP_SUMMARY
          if [ -z "${{ steps.version_bump.outputs.bumped }}" ]; then
            echo "Error: 'bumped' output is empty"
            exit 1
          fi

  test-npm:
    needs: build-dist
    runs-on: [ubuntu-latest]
    permissions:
      contents: write
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
      - name: Test NPM Action (Dry Run)
        id: version_bump
        uses: ./.github/actions/version-bumping/npm
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          package-json-file: "test-resources/package.json"
          dry-run: "true"

      - name: Verify Outputs
        run: |
          echo "Bumped: ${{ steps.version_bump.outputs.bumped }}"
          echo "New Version: ${{ steps.version_bump.outputs.new-version }}"
          echo "### NPM Test New Version: ${{ steps.version_bump.outputs.new-version }}" >> $GITHUB_STEP_SUMMARY
          if [ -z "${{ steps.version_bump.outputs.bumped }}" ]; then
            echo "Error: 'bumped' output is empty"
            exit 1
          fi

  test-maven:
    needs: build-dist
    runs-on: [ubuntu-latest]
    permissions:
      contents: write
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
      - name: Test Maven Action (Dry Run)
        id: version_bump
        uses: ./.github/actions/version-bumping/maven
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          dry-run: "true"
          pom-file: "test-resources/pom.xml"
          # removed actual settings.xml to avoid fetch setting in this simple test
          bump-command: "mvn org.codehaus.mojo:versions-maven-plugin:set -DnewVersion=@NEW_VERSION@"

      - name: Verify Outputs
        run: |
          echo "Bumped: ${{ steps.version_bump.outputs.bumped }}"
          echo "New Version: ${{ steps.version_bump.outputs.new-version }}"
          echo "### Maven Test New Version: ${{ steps.version_bump.outputs.new-version }}" >> $GITHUB_STEP_SUMMARY
          if [ -z "${{ steps.version_bump.outputs.bumped }}" ]; then
            echo "Error: 'bumped' output is empty"
            exit 1
          fi

  test-version-file:
    needs: build-dist
    runs-on: [ubuntu-latest]
    permissions:
      contents: write
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
      - name: Test Version File Action (Dry Run)
        id: version_bump
        uses: ./.github/actions/version-bumping/version-file
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          version-file: "test-resources/VERSION"
          dry-run: "true"

      - name: Verify Outputs
        run: |
          echo "Bumped: ${{ steps.version_bump.outputs.bumped }}"
          echo "New Version: ${{ steps.version_bump.outputs.new-version }}"
          echo "### Version File Test New Version: ${{ steps.version_bump.outputs.new-version }}" >> $GITHUB_STEP_SUMMARY
          if [ -z "${{ steps.version_bump.outputs.bumped }}" ]; then
            echo "Error: 'bumped' output is empty"
            exit 1
          fi
